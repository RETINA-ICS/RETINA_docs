[["index.html", "RETINA Documentation 1 Introduction to RETINA", " RETINA Documentation Betsy Cowdery 2024-11-07 1 Introduction to RETINA Dynamic monitoring, reporting and verification for implementing negative emission strategies in managed ecosystems (RETINA) ## What is the RETINA project Goals: Bring together biogeochemical models and MRV system to improve predictions of soil C, N and GHG emissions in agricultural systems. Inform landowners when making management decisions. "],["the-architecture-of-the-retina-project.html", "2 The architecture of the RETINA project 2.1 Main pieces of CODE that make up the RETINA project", " 2 The architecture of the RETINA project 2.1 Main pieces of CODE that make up the RETINA project The RETINA app primarily php code collects the data from the user shows sensor data to the user shows model run results to the user The RETINA database PSQL data catalogue dedicated to storing RETINA project specific information such as user login information site details site management records of model runs triggered through the RETINA app The data in the RETINA database is supposed to be separate from the BETY database (described below.) The PECAN code A bundle of R packages that handle processing and preparing the data collected from the app and other sources to use it as model inputs or compare with model outputs reading model outputs and preparing them for visualizations, comparison with collected data and further analysis For each model that is used in the RETINA project, there is a specific R PEcAn package that contains (at minimum) script for preparing climate data for the model script(s) for preparing configuration (i.e. parameterization) files for the model script to execute the model script to read the output of the model and translate it from model specific format in to a standardized format so that it can be easily comparible with other model outputs The RETINA R package A series of helper scripts written in R that are specific to the RETINA project and JHI and thus shouldn’t be merged back in with the pecan project These scripts complement the tasks listed more generally with the PECAN code. The BETY database PSQL database. While BETY does house some data, it is better to think of it as a metadatabase that primarily holds information on the location and format of data The BETY database is used to track the full provinance of all data used when a model run is generated by the RETINA app including: records of all raw data and processed data used for drivers, parameterization and benchmarking (for every step of processing) records of run settings and model specific parameterization for model runs records of model run status and output files "],["where-the-code-and-data-live.html", "3 Where the code and data live 3.1 Overall structure 3.2 The HPC (Gruffalo) 3.3 The Retina VM (and getting there from gruffalo) 3.4 Overview of Docker container 3.5 The RETINA app Docker container 3.6 The RETINA app user database Docker container 3.7 The PEcAn Docker container 3.8 The RStudio server Docker container 3.9 The BETY database Docker container 3.10 The model Docker containers", " 3 Where the code and data live i.e. Understanding the HPC, the RETINA VM and Docker 3.1 Overall structure need to fix diagram 3.2 The HPC (Gruffalo) HPC documentation 3.3 The Retina VM (and getting there from gruffalo) What is available on the VM vs gruffalo 3.4 Overview of Docker container Remake with our logos like pecan and rstudio: 3.5 The RETINA app Docker container 3.5.1 php code 3.5.2 API this might not be the right place to talk about the API … 3.6 The RETINA app user database Docker container 3.7 The PEcAn Docker container 3.7.1 PEcAn 3.8 The RStudio server Docker container 3.9 The BETY database Docker container and where files are stored on gruffalo / how they are seen on docker: 3.10 The model Docker containers (and where the dockerfiles live / setting everything up through pecan) ESPECIALLY REBUILDING DNDC! 3.10.1 DNDC 3.10.1.1 DNDC build files on the docker container More detail coming soon - essentially, the DNDC docker is built using a Dockerfile which is found here: \\shared\\projects\\joint\\202012_RETINA\\pecan\\docker\\models\\dndc\\Dockerfile this file tells how the container will be built, with what libraries, and what will be installed. There is a line in the dockerfile COPY dndc_build /src/dndc_build this copies the dndc_build folder that is in the SAME DIRECTORY as the dockerfile in to the docker container So if you want to rebuild the dockerfile with a different source code, you need to copy a new dndc_build folder into \\shared\\projects\\joint\\202012_RETINA\\pecan\\docker\\models\\dndc\\ and rebuild the docker. Or instead of copying it, symlink it. Which is I think what we were doing. So which builds of DNDC would you use to replace what’s being used on the docker container at the moment? 3.10.1.2 DNDC build files on the HPC There are multiple builds of DNDC (versions of the code) that can be used on the HPC and docker. There is a difference between builds that can run on the HPC and builds that can run on docker because the LIBRARIES are different. You can see this in the cmake files. They are all stored in \\\\narnia.cropdiversity.ac.uk\\shared\\projects\\joint\\202012_RETINA\\pecan\\volumes\\pecan\\pecan Right now you can see dndc_build (the original build of DNDC) - this works ONLY on the docker dndc_build_new (a build where David Cameron and I were experimenting to see if we could get DNDC to run on the HPC - I don’t think we need it.) dndc_build_M (a build where I was experimenting with M’s flags) - this works ONLY on the docker dndc_buld_M_local (this build compiles and runs on the HPC ie it has a different cmake setup) Note: if you are running DNDC on the HPC - you can just run it in the command line, but this will make Iain mad. Better to submit to the queue. The general idea for development is clunky (we never found a good solution) - Build a “local” version of DNDC and test it by running it on the HPC - This won’t use the app at all, but there are ways to continue to use code to help automate the model development process - Once you have a version of the model that is suitable to move over to use with the app, copy over the DNDC source files to the other dndc_build_M folder (which can’t be compiled here because it points to other libraries) but then go through a series of steps to move the new version of the model over to docker and rebuild there. (Notes on that coming soon and/or they should be in the documentation somewhere already … ) 3.10.2 BASGRA 3.10.3 ECOSSE "],["the-scary-diagram..html", "4 The scary diagram.", " 4 The scary diagram. This file was lost and needs to be redone … "],["pecan-1.html", "5 PEcAn 5.1 What is PEcAn? 5.2 Version of PEcAn that we are using 5.3 Packages", " 5 PEcAn 5.1 What is PEcAn? PEcAn general documentation 5.2 Version of PEcAn that we are using Link to our version of pecan on github (Note:this is a private repository.) 5.3 Packages The main packages that we have contributed to/used during the RETINA project include Base PEcAn settings packages (which we won’t talk about here) PEcAn::DB: for interfacing with the databases PEcAn::data.atmosphere: for processing meterological data Model specific packages: PEcAn::DNDC: for interfacing with the DNDC model PEcAn::BASGRA: for interfacing with the BASGRA model PEcAn::ECOSSE: for interfacing with the ECOSSE model Functions we have added to the rpecanapi do need to document this. "],["the-retina-package.html", "6 The RETINA Package 6.1 Functions", " 6 The RETINA Package This is an R package written specifically for the RETINA project that would not make sense to merge back into the PEcAn project. /projects/joint/202012_RETINA/pecan/volumes/pecan/pecan/RETINA 6.1 Functions 6.1.1 Database connections betyConnectRETINA retinaConnectRETINA 6.1.2 Soil API related get_soil_API load_combined_soil_data read_soil_df 6.1.3 Site/coordinate related gridref2BNG site2BETY "],["walkthrough-running-a-model.html", "7 Walkthrough running a model 7.1 Initializing a run 7.2 Via a web browser 7.3 Visualizations for app: 7.4 More about outputs", " 7 Walkthrough running a model 7.1 Initializing a run 7.2 Via a web browser If you just want to test that the workflow is working - but you can’t change inputs because you don’t have access to the app interface or the code You can paste the following link in any (?) web browser Version 1.1 (this will change if David updates the code) retina.hutton.ac.uk/retinaApp_activity_RunModel_Android_v1_1.php?getKey=CQHXu2H4S31dXt9VqWXd&amp;userName=retinaTesting@hutton.ac.uk&amp;userPass=kjasdf83AJNCTO039AA&amp;toid=osgb1000000175422042 the pieces of this link: - the domain: retina.hutton.ac.uk - the php script retina App_activity_RunModel_Android_v1_1.php which can be found in \\mnt\\shared\\projects\\joint\\202012_RETINA\\retina.hutton.ac.uk\\html - all the php scripts for the app are in this directory and very well documented - they are all written by David D. please ask before making any changes. - toid = osgb1000000175422042 - the site identifier: in this case, this is a site we have set up for testing model runs that is next to Balruddery. We call it TOID2 - DON’T TEST WITH TOIDS WE HAVEN’T SET UP YET - This starts a process that hangs (and we can’t seem to kill) and we will need to restart the docker. Once you click the link, you will get a message that you have a run ID: “Your activity has been recorded in the RETINA project database. A model has been run with Run ID: #####” This number is the RETINA RUN ID - Every time a request for a model run (or series of model runs) is sent from the app, it gets a retina run id. - If and only if this request is successful, the id is logged in the retina database This is different than the PECAN run ID - Every time a model is run, it is given a run id through PEcAn. - Even if the model is not successful, it will still be recorded in the BETY database. One RETINA RUN ID can be associated with many PECAN RUN ids But you can get both of these from the log files in \\\\narnia.cropdiversity.ac.uk\\shared\\projects\\joint\\202012_RETINA\\retina.hutton.ac.uk\\html\\logs rscript_results_log_DATE rscript_error_log_DATE The log files also point to model output directories : /mnt/shared/projects/joint/202012_RETINA/pecan/volumes/pecan/pecan/workflows/PECAN_PECANID 7.3 Visualizations for app: \\mnt\\shared\\projects\\joint\\202012_RETINA\\pecan\\volumes\\pecan\\pecan\\dbfiles\\input_app\\html The folder name is determined by the RETINA run id and a randomly generated id for security 7.4 More about outputs All model output is stored in the directory /mnt/shared/projects/joint/202012_RETINA/pecan/volumes/pecan/pecan/workflows in the directory associated with its bety database workflow id. This can be found in the retina database and is associated with the retina run id. Look at the retina run table: - If the run completed, the run will have a “finished at” date and a record for “out folder” this folder contians the output visulaizations, not the data itself however. - To see the actual data, use the retina_run_id to find the bety workflow_id in the pecan_model_runs table. Again, if the run didn’t complete, this record won’t exist. - Then either use this workflow id to determine the path manually - For example: - retina_run_id 198 - workflow_id: 99000001015 - output directory: /mnt/shared/projects/joint/202012_RETINA/pecan/volumes/pecan/pecan/workflows/PEcAn_99000001015 Alternatively, query the bety database for this path. It is the folder field in the workflows table. You could even do a joint query. Something along the lines of this if you queried from both databases: SELECT w.folder FROM workflows w LEFT JOIN pecan_model_runs p WHERE w.id = p.workflow_id Following this example of workflow 99000001015, inside this directory there is an out folder and then another layer of subdirectories. This is because the system has the potential to do ensemble runs. Then there would be multiple directories, each containing the output from a unique model run. As we are not running ensembles right now, there is only one sub directory. PEcAn_99000001015/out/99000000889/ This is where you will find the output of the run, for a single model and site. The output is separated in to annual files and is in netcdf format. 7.4.1 Server Side Scripts Coming soon setupPECAN.R submitPECAN.R 7.4.2 Retina side scripts Coming soon "],["restarting-docker.html", "8 Restarting Docker", " 8 Restarting Docker If changes are made to any RETINA functions (ie plotting) docker needs to be restarted go to the docker container cd /mnt/shared/projects/joint/202012_RETINA/pecan/docker/ docker compose down docker compose up -d Pick a TOID like osgb1000000175422042 Then try a new run: Version 1_1 retina.hutton.ac.uk/retinaApp_activity_RunModel_Android_v1_1.php?getKey=CQHXu2H4S31dXt9VqWXd&amp;userName=retinaTesting@hutton.ac.uk&amp;userPass=kjasdf83AJNCTO039AA&amp;toid=osgb1000000175422042 Version 1_0 &lt;https://retina.hutton.ac.uk/retinaApp_activity_RunModel_Android_v1_0.php?getKey=CQHXu2H4S31dXt9VqWXd&amp;userName=retinaTesting@hutton.ac.uk&amp;userPass=kjasdf83AJNCTO039AA&amp;toid=osgb1000000175422042&gt; "],["logs-and-errors.html", "9 Logs and Errors", " 9 Logs and Errors Look at logs and errors cd /mnt/shared/projects/joint/202012_RETINA/retina.hutton.ac.uk/html/logs watch less rscript_error_log.txt watch less rscript_results_log.txt &lt;https://retina.hutton.ac.uk/retinaApp_activity_RunModel_Android_v1_1.php?getKey=CQHXu2H4S31dXt9VqWXd&amp;userName=retinaTesting@hutton.ac.uk&amp;userPass=kjasdf83AJNCTO039AA&amp;toid=osgb1000002019663779&gt; retinaApp_activity_RunModel_Android_v1_1.php &amp; toid=osgb1000002019663779 "],["rebuilding-pecan-api.html", "10 Rebuilding pecan API", " 10 Rebuilding pecan API If you ever make changes to any of the pecan API functions, rebuilding pecan and bringing docker down and up won’t be enough for those changes to show. You need to rebuild the pecan API docker. Steps: After logging in to gruffalo and retina, go to the docker directory cd /mnt/shared/projects/joint/202012_RETINA/pecan/docker/ always check to make sure that you’re in the right docker folder with something like docker compose ps which will list all the running containers. If they don’t look familiar, you’re in the wrong place and you’re about to shut down the wrong docker. Turn back! When you’re ready, bring docker down docker compose down Then MOVE TO A NEW DOCKER DIRECTORY: the pecan api docker directory this is where you will rebuild the API docker cd apps/api docker build -t pecan/api:develop . When this has completed MOVE DIRECTORIES AGAIN back to the pecan docker directory either with cd ../.. or write out the full path again cd /mnt/shared/projects/joint/202012_RETINA/pecan/docker/ Bring docker up docker compose up -d Give it a minute for everything to start. But you might need bring docker up twice because API has some trouble starting. List all the running containers docker compose ps and check to see that pecan/api:develop is up and running and that it has just been updated! "],["the-dndc-model.html", "11 The DNDC Model 11.1 Versions of DNDC 11.2 DNDC Parameters 11.3 The dnd file", " 11 The DNDC Model This portion of the documentation that started as RETINA specific, but will now be used more generally for anyone in the group using DNDC. The goal is to document all the ways that DNDC is being used across the group, and create a repository of code and documentation for each version of the model that is being used. For now the documentation centers around the version of DNDC that has been integrated in to PEcAn, which I am calling DNDC_M or DNDC “Matthias,” the most recently developed version of the sourcecode for N-DNDC. 11.1 Versions of DNDC Currently the RETINA group is working with the following versions of DNDC Agro-ecosystems: Crop yield, soil carbon sequestration, nitrogen leaching, and trace gas emissions The DNDC Model (Version 9.5) with PC User interface Interface: YES Model with interface: http://www.dndc.sr.unh.edu/model/DNDC95.zip Documentation: http://www.dndc.sr.unh.edu/model/GuideDNDC95.pdf Scientific Documentation: pdf provided by Ed (where is it online?) Source code available on one drive Matthias Source Code - contians 3 versions DNDC “Idenways” which is the “original” Interface: NO (running on docker) Documentation: README files included with the source code written by Matthias Source code available on one drive DNDC “Matthias” &lt;– CURRENT VERSION USED BY RETINA Interface: NO (running on docker) Documentation: README files included with the source code written by Matthias Source code available on one drive Working version which is a mix of the two Potentially another “2014” version (need to check if/how this differs) Iden version before Matthias worked on it Version of DNDC may work best with Manure DNDC_source_Feb 17 2014 Version shared by Jagadeesh for the project that Ed is on Is there another version that was found on github The github version is what Umut is trying to get working with the manure flag…? leaf-models-public/DNDC at master · praxik/leaf-models-public (github.com) Livestock Farms: Greenhouse gas and ammonia emissions The Manure-DNDC Model Interface: YES Model: http://www.dndc.sr.unh.edu/model/ManureDNDC.rar Forested Ecosystems: Forest production, soil carbon sequestration, and trace gas emissions The Forest-DNDC Model Interface: YES Model: http://www.dndc.sr.unh.edu/model/ForestDNDC.zip Documentation: http://www.dndc.sr.unh.edu/model/ForestUserGuide.pdf UPDATE on getting exe models running on the HPC (2-20-2024): - It is going to be very difficult to get an exe to run on docker on the retina VM, maybe with wine - We are going to reach out to the individual developers to ask if they have compiled command line versions, we could even give them examples of how we did it - We could also possibly discuss moving away from docker altogether ## Github https://github.com/RETINA-ICS The idea is to put as many versions of DNDC on to the github as possible (as private repos) with documentation and then do comparisons (Where Betsy got code from Matthias) https://github.com/MatthiasMimault/DNDC_CC 11.2 DNDC Parameters Note the documentation for DNDC is written from the perspective of using DNDC95 and DNDC_Matthias. However, even if the other versions of DNDC do not look exactly the same, the approaches to using them should be similar. 11.2.1 The DNDC interface (Difficutly: Easy) The simplest way to choose the parameters for the DNDC model is to use the interface for DNDC. After choosing one’s land type, soil type and crop type, most essential parameters will be populated with presets and it will be possible to do a preliminary run to see if the model is working. For information on using the interface to DNDC95, look at the documentation on DNDC95. 11.2.2 Library Parameter Files (Difficutly: Moderate) Reading in default parameters from lookup tables based on crop id and soil type #### Crop Params 11.2.2.1 Soil Params 11.2.2.2 ? Params 11.2.3 The DNDC Source file (Difficutly: Advanced) 11.3 The dnd file 11.3.1 Role of the file 11.3.2 How to create a dnd file 11.3.2.1 With the DNDC interface 11.3.2.2 By hand 11.3.2.3 Using PEcAn and the RETINA app 11.3.2.3.1 Pre-made dnd files for the RETINA Project 11.3.2.3.1.1 Balruddery: Conventional Treatment 11.3.2.3.1.2 Balruddery: Sustainable Treatment 11.3.2.3.1.3 Glensaugh "],["info-in-google-drive.html", "12 Info in Google Drive 12.1 Documents 12.2 Spreadsheets", " 12 Info in Google Drive 12.1 Documents submitPEcAn - Google Docs App run notes - Google Docs RETINA Plans - Google Docs Automate crop and management pipeline from app to models - Google Docs RETINA WG3 priorities - Google Docs Untitled document - Google Docs TOID connection with pecan - Google Docs 12.2 Spreadsheets RETINA SUMMARY - Google Sheets Balruddery MIDDLE EAST - Google Sheets dnd_file_Balruddery_ME - Google Sheets MIDDLE_EAST - Google Sheets RETINA Parameters - Google Sheets DNDC_Crop_Parameters - Google Sheets "],["meeting-notes.html", "13 Meeting Notes", " 13 Meeting Notes Home of the project /mnt/shared/projects/joint/202012_RETINA/pecan/ cd to go to a new directory crtl + l clear the screen Tip: record a new macro and to use it crtl + space Main directory where work lives (scripts, data, etc) /mnt/shared/projects/joint/202012_RETINA/pecan/volumes/pecan/pecan workflows test_API dbfiles RETINA test_plots Inside rstudio on docker -/mnt/shared/projects/joint/202012_RETINA/pecan/volumes/pecan/pecan shortened to /data Portforwarding from Iain: ssh -L 8000:localhost:8000 -J ecowdery@gruffalo.cropdiversity.ac.uk ecowdery@retina ssh -L 8000:localhost:8000 -J ejones@gruffalo.cropdiversity.ac.uk ejones@retina ssh -L 8000:retina:8000 ejones@gruffalo.cropdiversity.ac.uk Notes from 23/5/24 Check out samba Once you have samba just paste this: DNDC code is in \\\\narnia.cropdiversity.ac.uk\\shared\\projects\\joint\\202012_RETINA\\pecan\\docker\\models\\dndc Check out the RETINA code \\\\narnia.cropdiversity.ac.uk\\shared\\projects\\joint\\202012_RETINA\\pecan\\volumes\\pecan\\pecan\\RETINA plot_wf_RETINA_func "],["plotting-visualizations.html", "14 Plotting Visualizations", " 14 Plotting Visualizations Pull plot_data.rds from the workflow directory to anywhere you want to use R library(tidyverse) test_model_output &lt;- readRDS(&quot;lot_data.rds&quot;) ggplot(test_model_output) + geom_line(aes(x = posix, y = value, group = group_plot, color = group_color)) + facet_grid(rows = vars(var), cols = vars(site), scales = &quot;free&quot;) + ggtitle(paste(Sys.time()))+ theme(legend.position=&quot;bottom&quot;) + scale_color_viridis_d(direction = -1) + theme_classic() test_model_output_wide &lt;- pivot_wider(test_model_output, names_from = var, values_from = value ) "],["notes-on-ongoing-dndc-solutions-and-the-hpc.html", "15 Notes on ongoing DNDC solutions and the HPC", " 15 Notes on ongoing DNDC solutions and the HPC RETINA solution (Bhaskar &amp; Priscila): Ask for non-GUI, linux compilers Ideally source code Linux VM (Betsy): Exists See if I can remote desktop try to use wine Windows VM (Betsy): Doesn’t exist Ask Iain for a windows VM "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
